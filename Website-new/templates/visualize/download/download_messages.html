{% extends "main.html" %}

{% block title %}Discord Message Extractor{% endblock %}

{% block head %}

{% endblock %}

{% block body %}
<h1>Discord Message Extractor</h1>
<form id="discord-form">
    <div class="mb-3 row">
        <label for="auth-token" class="col-sm-2">Discord authorization key</label>
        <div class="col-sm-10">
            <input type="text" class="form-control" id="auth-token" placeholder="Enter your Discord Token" required>
        </div>
    </div>

    <div class="mb-3 row">
        <label for="channel-name" class="col-sm-2">Channel URL</label>
        <div class="col-sm-10">
            <input type="text" class="form-control" id="channel-url" placeholder="Enter the channel URL (https://discord.com/channels/n/m)" required>
        </div>
    </div>

    <div class="mb-3 row">
        <label for="num-messages" class="col-sm-2"># of messages to save</label>
        <div class="col-sm-10">
            <input type="number" class="form-control" id="num-messages" min="1" max="100000000" value="50">
        </div>
    </div>

    <button type="submit" class="btn btn-primary">Submit</button>
    <button id="downloadBtn" class="btn btn-primary" disabled>Download
        Messages</button>

</form>

<div id="result"></div>

<script>
    // This code is responsible for extracting messages from the discord.

    class DiscordAPI {
        constructor(authToken) {
            this.DISCORD_EPOCH = 1420070400000n;
            this.setAuthorization(authToken);
        }
        setAuthorization(token) {
            this.authToken = token;
        }

        //Snowflake is a epoch-based way of calculating timestamps with more information
        convertTimestampToSnowflake(timestamp) {
            return ((BigInt(new Date(timestamp).getTime()) - this.DISCORD_EPOCH) << 22n).toString();
        }

        constructSearchParams(options) {
            const params = new URLSearchParams();
            if (options.author_id) params.append('author_id', options.author_id);
            if (options.mentions) params.append('mentions', options.mentions);
            if (options.has && options.has.length > 0) params.append('has', options.has.join(','));
            if (options.pinned) params.append('pinned', 'true');
            if (options.before) params.append('before', options.before);
            if (options.after) params.append('after', options.after);
            return params.toString();
        }

        async fetchMessages(apiUrl) {
            try {
                const response = await fetch(`/cors-bypass/${apiUrl}`, {
                    method: 'GET',
                    headers: {
                        Authorization: this.authToken,
                        'Content-Type': 'application/json'
                    }
                });
                return await response.json();
            } catch (error) {
                console.error('Error fetching messages:', error);
                return [];
            }
        }

        async fetchChannelMessages(channelId, options) {

            //TODO: add some logic that verifies channel (or just use response code?)
            const allMessages = [];
            let startTime, endTime;
            options.limit = options.limit || 100;

            // Start timing
            startTime = performance.now();

            while (options.limit > 0) {
                const apiUrl = `https://discord.com/api/v9/channels/${channelId}/messages?limit=${Math.min(options.limit, 100)}&${this.constructSearchParams(options)}`;
                console.log(`API URL: ${apiUrl}`);
                const messages = await this.fetchMessages(apiUrl);
                allMessages.push(...messages);

                if (messages.length < 100) break;

                const lastMessage = messages[messages.length - 1];
                options.before = this.convertTimestampToSnowflake(lastMessage.timestamp);
                options.limit -= messages.length;
            }

            // End timing
            endTime = performance.now();
            console.log(`Time taken: ${(endTime - startTime).toFixed(2)} milliseconds`);

            console.log(`Fetched ${allMessages.length} messages`);
            return allMessages;
        }


        saveMessagesToFile(messages) {
            // Reverse the order of the messages
            const reversedMessages = messages.reverse().map(message => `${message.author.username}: ${message.content}`).join('\n');

            // Create a Blob from the reversed messages
            const blob = new Blob([reversedMessages]);

            // Create a link element
            const a = window.parent.document.createElement('a'); // Use parent document
            a.style.display = 'block'; // Hide the link element
            a.href = window.parent.URL.createObjectURL(blob); // Create Blob URL in parent context
            a.download = 'discord_messages.txt';
            a.innerText = "Discord Messages";

            // Append the link to the parent document
            window.parent.document.body.appendChild(a);

            // Trigger the download
            a.click();

            // Cleanup after download
            // window.parent.URL.revokeObjectURL(a.href); // Revoke the Blob URL in parent context
            // window.parent.document.body.removeChild(a); // Remove the link from the parent document

            console.log('Messages saved to discord_messages.txt in reversed order.');
        }

    }

    document.getElementById('discord-form').addEventListener('submit', async function (e) {
        e.preventDefault();

        const authToken = document.getElementById('auth-token').value;
        const channelURL = document.getElementById('channel-url').value;
        const numMsg = document.getElementById('num-messages').value * 1;
        const channelId = channelURL.split('/').pop();
        const downloadBtn = document.getElementById('downloadBtn');

        // Create an instance of the DiscordAPI class
        const discordAPI = new DiscordAPI(authToken);
        const searchOptions = {
            author_id: null,
            mentions: null,
            has: [],
            pinned: false,
            before: null,
            after: null,
            limit: numMsg
        };

        // Fetch messages and handle button state
        const messages = await discordAPI.fetchChannelMessages(channelId, searchOptions);

        if (messages.length > 0) {
            // Enable the download button and change its color to green
            downloadBtn.disabled = false;
            downloadBtn.style.backgroundColor = 'green';

            // Attach event listener for downloading when the button is clicked
            downloadBtn.onclick = function () {
                discordAPI.saveMessagesToFile(messages);
                downloadBtn.disabled = true;
                downloadBtn.style.backgroundColor = 'gray';

            };
        }
    });

</script>
{% endblock %}