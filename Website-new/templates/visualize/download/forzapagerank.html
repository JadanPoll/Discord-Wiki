<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Forza PageRank</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            display: flex;
            justify-content: space-between;
            margin: 0;
            padding: 0;
            background-color: #f4f4f9;
        }
        #treeview-container {
            width: 30%;
            padding: 20px;
            border-right: 2px solid #ddd;
            background-color: #fff;
            height: 100vh;
            overflow-y: auto;
        }
        #content-container {
            width: 65%;
            padding: 20px;
            background-color: #fff;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        h2 {
            color: #333;
        }
        #content-display {
            margin-top: 20px;
            padding: 10px;
            border: 1px solid #ddd;
            background-color: #fafafa;
        }
        ul {
            list-style-type: none;
            padding-left: 20px;
        }
        li {
            cursor: pointer;
            padding: 8px 0;
            font-size: 16px;
            transition: background-color 0.3s;
        }
        li:hover {
            background-color: #f0f0f0;
        }
        li.expanded::before {
            content: '▲';
            margin-right: 10px;
            color: #007BFF;
        }
        li::before {
            content: '▼';
            margin-right: 10px;
            color: #007BFF;
        }
        li ul {
            display: none;
            padding-left: 20px;
        }
        li.expanded ul {
            display: block;
        }
        .tree-item {
            display: flex;
            align-items: center;
        }
        .tree-item > span {
            margin-right: 5px;
        }
    </style>
</head>
<body>

    <div id="treeview-container">
        <ul id="treeview"></ul>
    </div>

    <div id="content-container">
        <h2>Selected Item Content</h2>
        <div id="content-display">Select an item from the treeview to see the content.</div>
    </div>
    <div>
        <button id="loadButton">Load Discord JSON</button>
    </div>

    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>

    <script type="module" src="/discord-stopword-en.js"></script>
    <script type="module" src="/engine.js"></script>
    <script type="module">
        import { loadConversationEngine, generateAndDisplayAllRandomContextChain } from '/engine.js';
        class GroupHierarchyWithTreeview {
            constructor(hierarchicalRelationships, independentGroups) {
                this.hierarchicalRelationships = hierarchicalRelationships;
                this.independentGroups = independentGroups;
            }

            populateTreeview() {
                const tree = $("#treeview");
                const addedGroups = new Set();

                // Add independent groups
                this.independentGroups.forEach(group => {
                    if (!addedGroups.has(group)) {
                        tree.append(`<li id="${group}" class="tree-item">${group}</li>`);
                        addedGroups.add(group);
                    }
                });


                // Add hierarchical relationships
                for (const [groupName, relationship] of Object.entries(this.hierarchicalRelationships)) {
                    const escapedGroupName = $.escapeSelector(groupName);

                 
                    if (!addedGroups.has(groupName)) {
                        console.log("Adding");

                        // Escape special characters in the group name for safe use in selectors

                        // Append group to tree
                        tree.append(`<li id="${escapedGroupName}" class="tree-item">${groupName}<ul id="${escapedGroupName}_subgroups"></ul></li>`);
                        addedGroups.add(groupName);
                    }

                    relationship.subgroups.forEach(subgroup => {
                        // Escape special characters in the subgroup name for safe use in selectors
                        const escapedSubgroup = $.escapeSelector(subgroup);
                        
                        const subgroupParent = $(`#${escapedGroupName}_subgroups`);
                        if (!subgroupParent.find(`#${escapedSubgroup}`).length) {
                            // Append subgroup to the group's subgroups
                            subgroupParent.append(`<li id="${escapedSubgroup}" class="tree-item">${subgroup}</li>`);
                        }
                    });
                }


                // Add event listener for tree item clicks
                $(".tree-item").on("click", (event) => {
                    event.stopPropagation();  // Prevent click event from bubbling up to parent elements
                    const selectedItem = $(event.target).attr('id');  // Get the ID of the selected item
                    this.onTreeItemClick(selectedItem);
                });

                // Expand or collapse subgroups on parent click
                $(".tree-item").on("click", function() {
                    $(this).toggleClass('expanded');
                });
            }

            onTreeItemClick(selectedItem) {
                this.displaySelectedContent(selectedItem);
            }

            displaySelectedContent(itemName) {
                console.log(itemName)
                const contentDisplay = $("#content-display");

                // Assuming glossary is an object where item names map to content index arrays
                const contentIndexArray = glossary[itemName][0];

                if (contentIndexArray && contentIndexArray.length > 0) {
                    let content = ''; // Initialize content to store all messages

                    // Loop through the content_index_array and build the content from conversation_block
                    contentIndexArray.forEach(ind => {
                        const message = conversation_block[ind];
                        if (message) {
                            content += `<p><strong>Message ${ind}:</strong> ${message}</p>`;
                        }
                    });

                    contentDisplay.html(content); // Display the concatenated content
                } else if (this.hierarchicalRelationships[itemName]) {
                    const subgroups = this.hierarchicalRelationships[itemName].subgroups.join(", ");
                    contentDisplay.html(`<strong>${itemName}</strong><br>Subgroups: ${subgroups}`);
                } else if (this.independentGroups.includes(itemName)) {
                    contentDisplay.html(`<strong>${itemName}</strong><br>This is an independent group.`);
                } else {
                    contentDisplay.html("No content available for this item.");
                }
            }
        }

        function loadConversation(fileContent) 
        {
            try {


                console.log("Loading...")
                                // Load the conversation blocks
                const { conversationBlocks } = loadConversationEngine(fileContent);
                console.log(conversationBlocks)
                // Call the function and destructure the object return value
                const { dictionaryGlossaryTopicAndLinkedConversationGroups, independentGroups, hierarchicalRelationships } = generateAndDisplayAllRandomContextChain();
                console.log(independentGroups,hierarchicalRelationships)
                const temp = new GroupHierarchyWithTreeview(hierarchicalRelationships,independentGroups)
                temp.populateTreeview()
                // Store glossary and conversation blocks in global variables
                window.glossary = dictionaryGlossaryTopicAndLinkedConversationGroups;
                window.conversation_block = conversationBlocks;

                // Optionally, update initial content display
                $("#content-display").html("Conversation loaded. Select an item from the treeview.");
            } catch (error) {
                console.error("Error loading conversation:", error);
                $("#content-display").html("Failed to load conversation.");
            }
        }




        // Event listener for the "Load JSON" button
        $(document).ready(function() {
            $("#loadButton").on("click", function() {
                // Create a file input element dynamically
                const fileInput = document.createElement('input');
                fileInput.type = 'file';  // Set file input type
                fileInput.accept = '.json';  // Restrict to JSON files

                // Event listener for when a file is selected
                fileInput.addEventListener('change', function(event) {
                    const file = fileInput.files[0];  // Get the selected file
                    if (!file) {
                        console.log('No file selected.');
                        return;
                    }

                    const fileReader = new FileReader();

                    // When the file is loaded, process it
                    fileReader.onload = function() {
                        const fileContent = fileReader.result;
                        loadConversation(fileContent); // Pass file content to loadConversation
                    };

                    // Read the selected file as text
                    fileReader.readAsText(file);
                });

                // Trigger the file input dialog
                fileInput.click();
            });
        });



    </script>
</body>
</html>
